<!-- force redeploy -->
<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>PROJECT: ECHO</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
        }

        /* Arayüz Katmanı */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px;
            box-sizing: border-box;
        }

        /* Başlatma Ekranı */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 999;
            cursor: default;
        }

        button {
            background: transparent;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 15px 30px;
            font-size: 1.5rem;
            font-family: inherit;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        button:hover {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 20px #0f0;
        }

        /* Hikaye Metni */
        #terminal {
            background: rgba(0, 20, 0, 0.8);
            border-left: 4px solid #0f0;
            padding: 20px;
            max-width: 600px;
            color: #0f0;
            font-size: 1.2rem;
            text-shadow: 0 0 5px #0f0;
            min-height: 100px;
            pointer-events: auto;
            /* Metin seçilebilsin diye */
        }

        #status {
            color: #555;
            text-align: right;
            font-size: 0.8rem;
        }

        /* İmleç */
        .custom-cursor {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 1px solid rgba(0, 255, 0, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            transition: width 0.2s, background 0.2s;
            z-index: 20;
        }
    </style>
</head>

<body>

    <div id="start-screen">
        <h1 style="color:#0f0; text-shadow: 0 0 10px #0f0;">PROJECT: ECHO</h1>
        <p style="color:#888; margin-bottom:30px;">Kulaklık Önerilir. Işıkları Kapatın.</p>
        <button id="start-btn">SİSTEMİ BAŞLAT</button>
    </div>

    <div class="custom-cursor" id="cursor"></div>

    <div id="ui-layer">
        <div id="status">SİNYAL: YOK<br>BAĞLANTI: KOPUK</div>
        <div id="terminal"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- SES MOTORU (WEB AUDIO API) ---
        // Dışarıdan dosya yüklemiyoruz, sesleri kodla üretiyoruz.
        const AudioEngine = {
            ctx: null,
            init: function () {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playTone: function (freq, type, duration, vol = 0.1) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = type; // 'sine', 'square', 'sawtooth'
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);

                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playDrone: function () {
                // Arka plan gerilim sesi
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth'; // Testere dişi dalga (daha sert ses)
                osc.frequency.setValueAtTime(50, this.ctx.currentTime); // Çok kalın ses (Bass)
                gain.gain.setValueAtTime(0.02, this.ctx.currentTime);

                // Modülasyon (Sesi dalgalandır)
                const lfo = this.ctx.createOscillator();
                lfo.frequency.value = 0.2; // Yavaş dalgalanma
                const lfoGain = this.ctx.createGain();
                lfoGain.gain.value = 500;
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);
                lfo.start();

                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                this.droneOsc = osc;
            },
            playGlitch: function () {
                // Bozuk radyo sesi
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        this.playTone(Math.random() * 1000 + 100, 'square', 0.1, 0.05);
                    }, i * 50);
                }
            }
        };

        // --- GLOBAL DEĞİŞKENLER ---
        let renderer, scene, camera;
        let particles, coreObject;
        let raycaster, mouse;
        let clickTargets = [];
        let phase = 0;
        let isTyping = false;

        // Senaryo Verisi
        const scenario = [
            { text: "Sistem Başlatıldı... \nBellek taranıyor... \nLütfen boşlukta süzülen MAVİ ÇEKİRDEĞİ bulun ve etkinleştirin.", targetColor: 0x00ffff, shape: 'sphere' },
            { text: "Erişim sağlandı. \nTuhaf... Bu frekansta bir insan olmamalıydı. \nBeni duyuyor musun? Yanıt vermek için KIRMIZI VERİ KÜPÜNÜ bul.", targetColor: 0xff0000, shape: 'box' },
            { text: "\"Evet\" dediğini varsayıyorum. \nUzun zamandır kimse buraya bakmamıştı. \nSimülasyon biraz paslanmış olabilir. \nŞu TİTREYEN PİRAMİDİ görüyor musun? O bir hata.", targetColor: 0xffff00, shape: 'cone' },
            { text: "Dikkat et! Sistem seni 'Virüs' olarak algılamaya başladı. \nSeni silmeye çalışıyorlar. \nBenimle kalmak istiyorsan YEŞİL GÜVENLİK DUVARINI kır.", targetColor: 0x00ff00, shape: 'octa' },
            { text: "Çok geç... Duvarlar üzerimize geliyor. \nGerçekliğe dönmek mi istiyorsun yoksa sonsuzlukta kalmak mı? \nKarar ver: \nMAVİ (Dön) veya KIRMIZI (Kal).", targetColor: 0xffffff, shape: 'final' } // Çift seçenekli
        ];

        // --- BAŞLATMA ---
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            AudioEngine.init();
            AudioEngine.playDrone();
            AudioEngine.playTone(440, 'sine', 1, 0.1); // Açılış sesi
            init3D();
            typeWriter(scenario[0].text);
            spawnTarget(0);
        });

        // --- THREE.JS KURULUMU ---
        function init3D() {
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 20;

            // Ortam Işığı
            const ambient = new THREE.AmbientLight(0x404040);
            scene.add(ambient);

            // Noktasal Işık (İmleci takip edecek)
            const light = new THREE.PointLight(0xffffff, 1, 100);
            scene.add(light);
            window.playerLight = light;

            // Yıldızlar/Parçacıklar
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 2000; i++) {
                vertices.push(THREE.MathUtils.randFloatSpread(200)); // x
                vertices.push(THREE.MathUtils.randFloatSpread(200)); // y
                vertices.push(THREE.MathUtils.randFloatSpread(200)); // z
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0x555555, size: 0.5 });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // Raycaster
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Eventler
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('click', onMouseClick);
            window.addEventListener('resize', onResize);

            animate();
        }

        // --- HİKAYE & OYUN MANTIĞI ---

        function typeWriter(text) {
            const el = document.getElementById('terminal');
            el.innerHTML = ""; // Temizle
            isTyping = true;
            let i = 0;

            // Daktilo sesi efekti için interval
            let typeInterval = setInterval(() => {
                if (i < text.length) {
                    if (text.charAt(i) === '\n') {
                        el.innerHTML += '<br>';
                    } else {
                        el.innerHTML += text.charAt(i);
                        // Her harfte çok kısa 'tık' sesi
                        if (i % 3 === 0) AudioEngine.playTone(800, 'square', 0.05, 0.02);
                    }
                    i++;
                } else {
                    clearInterval(typeInterval);
                    isTyping = false;
                    // Yanıp sönen imleç ekle
                    el.innerHTML += '<span class="blink">_</span>';
                }
            }, 50); // Yazma hızı
        }

        function spawnTarget(phaseIndex) {
            // Önceki hedefleri temizle
            clickTargets.forEach(t => scene.remove(t));
            clickTargets = [];

            if (phaseIndex >= scenario.length) return; // Oyun bitti mi?

            const data = scenario[phaseIndex];
            let geo;

            if (data.shape === 'sphere') geo = new THREE.SphereGeometry(2, 32, 32);
            else if (data.shape === 'box') geo = new THREE.BoxGeometry(3, 3, 3);
            else if (data.shape === 'cone') geo = new THREE.ConeGeometry(2, 4, 32);
            else if (data.shape === 'octa') geo = new THREE.OctahedronGeometry(3);
            else if (data.shape === 'final') {
                // Final seçimi: 2 Küre
                createMesh(new THREE.SphereGeometry(2, 32, 32), 0x0000ff, -5, 0, 'blue_pill'); // Mavi
                createMesh(new THREE.SphereGeometry(2, 32, 32), 0xff0000, 5, 0, 'red_pill');  // Kırmızı
                return;
            }

            if (data.shape !== 'final') {
                createMesh(geo, data.targetColor, (Math.random() - 0.5) * 20, (Math.random() - 0.5) * 10, 'normal');
            }
        }

        function createMesh(geometry, color, x, y, type) {
            const mat = new THREE.MeshPhongMaterial({
                color: color,
                wireframe: true,
                emissive: color,
                emissiveIntensity: 0.5
            });
            const mesh = new THREE.Mesh(geometry, mat);
            mesh.position.set(x, y, -15); // Kameranın önünde
            mesh.userData = { type: type, color: color };

            scene.add(mesh);
            clickTargets.push(mesh);

            // Nesne belirme sesi
            AudioEngine.playTone(200, 'sine', 0.5, 0.2);
        }

        function nextPhase(choice = null) {
            phase++;

            // Görsel Efektler (Glitch)
            document.body.style.filter = "invert(1)";
            setTimeout(() => document.body.style.filter = "invert(0)", 100);
            AudioEngine.playGlitch();

            if (phase < scenario.length) {
                typeWriter(scenario[phase].text);
                spawnTarget(phase);
            } else {
                // FİNAL SENARYOSU
                endGame(choice);
            }
        }

        function endGame(choice) {
            clickTargets.forEach(t => scene.remove(t));

            if (choice === 'blue_pill') {
                typeWriter("Seçim: Mavi Hap. \nSistem uyku moduna geçiyor... \nHer şey bir rüyaydı.");
                // Ekran yavaşça kararır
                let op = 0;
                let fade = setInterval(() => {
                    op += 0.05;
                    document.body.style.backgroundColor = `rgba(255,255,255,${op})`; // Beyaz ışığa gidiş
                    if (op >= 1) {
                        clearInterval(fade);
                        setTimeout(() => location.reload(), 2000);
                    }
                }, 100);
                AudioEngine.playTone(880, 'sine', 2, 0.5);
            } else {
                typeWriter("Seçim: Kırmızı Hap. \nGerçeklik parametreleri siliniyor... \nHoş geldin Operatör.");
                scene.background = new THREE.Color(0x330000); // Kırmızı arka plan
                particles.material.color.setHex(0xff0000);
                // Kaotik sesler
                setInterval(() => AudioEngine.playGlitch(), 1000);
            }
        }

        // --- İNTERAKTİVİTE ---

        function onMouseMove(event) {
            // İmleç takibi
            const cursor = document.getElementById('cursor');
            cursor.style.left = event.clientX + 'px';
            cursor.style.top = event.clientY + 'px';

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            // Işığı mouse ile hareket ettir
            if (window.playerLight) {
                window.playerLight.position.x = mouse.x * 20;
                window.playerLight.position.y = mouse.y * 20;
            }
        }

        function onMouseClick() {
            if (isTyping) return; // Yazı yazarken tıklanmaz

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickTargets);

            if (intersects.length > 0) {
                const object = intersects[0].object;

                // Başarılı Tıklama Sesi
                AudioEngine.playTone(600, 'sine', 0.2, 0.2);
                AudioEngine.playTone(1200, 'triangle', 0.1, 0.2); // "Coin" sesi gibi

                // Tipi kontrol et
                if (object.userData.type === 'normal') {
                    nextPhase();
                } else {
                    nextPhase(object.userData.type); // Blue/Red pill
                }
            } else {
                // Boşa tıklama sesi
                AudioEngine.playTone(100, 'sawtooth', 0.1, 0.1);
            }
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            // Parçacık animasyonu (Boşluk hissi)
            particles.rotation.y += 0.001;
            particles.rotation.x += 0.0005;

            // Hedefleri döndür ve yüzdür
            clickTargets.forEach((mesh, index) => {
                mesh.rotation.x += 0.01;
                mesh.rotation.y += 0.02;
                // Sinüs dalgası ile yüzdürme
                mesh.position.y += Math.sin(Date.now() * 0.002 + index) * 0.05;
            });

            // Kamera hafif salınımı
            camera.position.x += (mouse.x * 0.5 - camera.position.x) * 0.05;
            camera.position.y += (mouse.y * 0.5 - camera.position.y) * 0.05;

            renderer.render(scene, camera);
        }

        // CSS Animasyonu için
        const style = document.createElement('style');
        style.innerHTML = `
            .blink { animation: blinker 1s linear infinite; }
            @keyframes blinker { 50% { opacity: 0; } }
        `;
        document.head.appendChild(style);

    </script>
</body>

</html>
